name: CI

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Format check
        run: cargo fmt --all --check
      - name: Clippy
        run: cargo clippy --workspace --all-targets -- -D warnings
      - name: Test
        run: cargo test --workspace

  integration-dry-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Compat runtime dry-run
        run: timeout 5s cargo run -p odin-cli -- --config config/default.yaml || [ $? -eq 124 ]

  contract-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Workflow contract lint
        run: bash scripts/verify/workflow-contract.sh
      - name: SASS skills contract lint
        run: bash scripts/verify/skills-contract.sh
      - name: Plugin schema JSON validity
        run: jq empty schemas/plugin-manifest.v1.schema.json
      - name: Example manifest exists
        run: test -f examples/odin.plugin.yaml

  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  dependency-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cargo audit install
        run: cargo install cargo-audit --locked
      - name: Cargo audit
        run: cargo audit

  verify:
    runs-on: ubuntu-latest
    needs: lint-test
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Install Python rich
        run: pip install rich
      - name: Build workspace
        run: cargo build --workspace
      - name: Quickstart smoke
        run: bash scripts/verify/quickstart-smoke.sh
      - name: Plugin install matrix
        run: bash scripts/verify/plugin-install-matrix.sh
      - name: TUI core smoke
        run: bash scripts/verify/tui-core-smoke.sh
      - name: Bootstrap wrapper smoke
        run: bash scripts/verify/bootstrap-wrapper-smoke.sh
      - name: Docs command smoke
        run: bash scripts/verify/docs-command-smoke.sh
