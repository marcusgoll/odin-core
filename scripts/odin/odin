#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/bootstrap.sh"

odin_bootstrap_should_delegate_native() {
  local args=("$@")
  local command="${args[0]:-help}"
  local has_dry_run="no"
  local arg

  if [[ "${ODIN_BOOTSTRAP_FORCE_BASH:-}" == "1" ]]; then
    return 1
  fi

  for arg in "${args[@]}"; do
    case "${arg}" in
      --dry-run)
        has_dry_run="yes"
        ;;
      --guardrails|--guardrails=*)
        return 1
        ;;
    esac
  done

  if [[ "${has_dry_run}" != "yes" ]]; then
    return 1
  fi

  case "${command}" in
    connect|start|tui|verify)
      return 0
      ;;
    inbox)
      [[ "${args[1]:-}" == "add" ]]
      return
      ;;
    *)
      return 1
      ;;
  esac
}

odin_bootstrap_try_native() {
  local args=("$@")

  odin_bootstrap_run_native() {
    if command -v timeout >/dev/null 2>&1; then
      timeout "${ODIN_BOOTSTRAP_NATIVE_TIMEOUT_SECONDS:-20}" "$@"
    else
      "$@"
    fi
  }

  if [[ -x "${ODIN_BOOTSTRAP_ROOT_DIR}/target/release/odin-cli" ]]; then
    odin_bootstrap_run_native "${ODIN_BOOTSTRAP_ROOT_DIR}/target/release/odin-cli" "${args[@]}"
    return $?
  fi

  if [[ -x "${ODIN_BOOTSTRAP_ROOT_DIR}/target/debug/odin-cli" ]]; then
    odin_bootstrap_run_native "${ODIN_BOOTSTRAP_ROOT_DIR}/target/debug/odin-cli" "${args[@]}"
    return $?
  fi

  if command -v odin-cli >/dev/null 2>&1; then
    odin_bootstrap_run_native odin-cli "${args[@]}"
    return $?
  fi

  if command -v cargo >/dev/null 2>&1; then
    (
      cd "${ODIN_BOOTSTRAP_ROOT_DIR}"
      odin_bootstrap_run_native cargo run -q -p odin-cli -- "${args[@]}"
    )
    return $?
  fi

  return 1
}

if odin_bootstrap_should_delegate_native "$@"; then
  if odin_bootstrap_try_native "$@"; then
    exit 0
  fi
fi

odin_bootstrap_dispatch "$@"
