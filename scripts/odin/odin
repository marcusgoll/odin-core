#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/bootstrap.sh"

odin_bootstrap_should_delegate_native() {
  local args=("$@")
  local command="${args[0]:-help}"
  local source=""

  if [[ "${ODIN_BOOTSTRAP_FORCE_BASH:-}" == "1" ]]; then
    return 1
  fi

  case " ${args[*]} " in
    *" --guardrails "*|*" --guardrails="*)
      return 1
      ;;
  esac

  case "${command}" in
    connect)
      if [[ "${#args[@]}" -ne 4 ]]; then
        return 1
      fi
      if [[ "${args[3]}" != "--dry-run" ]]; then
        return 1
      fi
      case "${args[2]}" in
        oauth|api)
          return 0
          ;;
        *)
          return 1
          ;;
      esac
      ;;
    start|tui|verify)
      [[ "${#args[@]}" -eq 2 && "${args[1]}" == "--dry-run" ]]
      return
      ;;
    inbox)
      case "${args[1]:-}" in
        add)
          [[ "${#args[@]}" -eq 4 && "${args[3]}" == "--dry-run" ]]
          return
          ;;
        list)
          [[ "${#args[@]}" -eq 3 && "${args[2]}" == "--dry-run" ]]
          return
          ;;
        *)
          return 1
          ;;
      esac
      ;;
    gateway)
      if [[ "${args[1]:-}" != "add" ]]; then
        return 1
      fi
      source="${args[2]:-}"
      case "${source}" in
        cli|slack|telegram)
          [[ "${#args[@]}" -eq 4 && "${args[3]}" == "--dry-run" ]]
          return
          ;;
        *)
          return 1
          ;;
      esac
      ;;
    *)
      return 1
      ;;
  esac
}

odin_bootstrap_try_native() {
  local args=("$@")

  odin_bootstrap_run_native() {
    if command -v timeout >/dev/null 2>&1; then
      timeout "${ODIN_BOOTSTRAP_NATIVE_TIMEOUT_SECONDS:-20}" "$@"
    else
      "$@"
    fi
  }

  if [[ -x "${ODIN_BOOTSTRAP_ROOT_DIR}/target/release/odin-cli" ]]; then
    odin_bootstrap_run_native "${ODIN_BOOTSTRAP_ROOT_DIR}/target/release/odin-cli" "${args[@]}"
    return $?
  fi

  if [[ -x "${ODIN_BOOTSTRAP_ROOT_DIR}/target/debug/odin-cli" ]]; then
    odin_bootstrap_run_native "${ODIN_BOOTSTRAP_ROOT_DIR}/target/debug/odin-cli" "${args[@]}"
    return $?
  fi

  if command -v odin-cli >/dev/null 2>&1; then
    odin_bootstrap_run_native odin-cli "${args[@]}"
    return $?
  fi

  if command -v cargo >/dev/null 2>&1; then
    (
      cd "${ODIN_BOOTSTRAP_ROOT_DIR}"
      odin_bootstrap_run_native cargo run -q -p odin-cli -- "${args[@]}"
    )
    return $?
  fi

  return 127
}

# Handle import command directly (not delegated to native CLI)
if [[ "${1:-}" == "import" ]]; then
  shift
  exec bash "${SCRIPT_DIR}/odin-import.sh" "$@"
fi

if odin_bootstrap_should_delegate_native "$@"; then
  if odin_bootstrap_try_native "$@"; then
    exit 0
  else
    native_rc=$?
    if [[ "${native_rc}" -ne 127 ]]; then
      exit "${native_rc}"
    fi
  fi
fi

odin_bootstrap_dispatch "$@"
